# 数据库设计

<cite>
**本文引用的文件**
- [lib/db.ts](file://lib/db.ts)
- [lib/seed.ts](file://lib/seed.ts)
- [types/index.ts](file://types/index.ts)
- [app/api/layers/route.ts](file://app/api/layers/route.ts)
- [app/api/categories/route.ts](file://app/api/categories/route.ts)
- [app/api/tech-items/route.ts](file://app/api/tech-items/route.ts)
- [app/api/stats/route.ts](file://app/api/stats/route.ts)
- [PROJECT_MIGRATION.md](file://PROJECT_MIGRATION.md)
- [package.json](file://package.json)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介
本文件面向 Lantu Next 项目的数据库设计，聚焦三层数据库架构：
- layers 层级表：用于组织技术栈的顶层分层
- categories 分类表：在层级下进一步细分技术领域
- tech_items 技术项表：具体的技术条目，如框架、语言、工具等

文档将详细说明表结构、字段语义、外键约束、索引策略、数据初始化脚本原理与扩展方法，并给出数据迁移、备份恢复与性能优化建议，以及常见 SQL 查询示例与数据访问模式。

## 项目结构
数据库相关代码集中在以下模块：
- 数据库连接与初始化：lib/db.ts
- 数据初始化脚本：lib/seed.ts
- 类型定义：types/index.ts
- API 路由：app/api/{layers,categories,tech-items,stats}/route.ts
- 项目迁移与说明：PROJECT_MIGRATION.md
- 项目脚本与依赖：package.json

```mermaid
graph TB
subgraph "应用层"
API_L["/api/layers"]
API_C["/api/categories"]
API_T["/api/tech-items"]
API_S["/api/stats"]
end
subgraph "服务层"
DB["lib/db.ts<br/>数据库操作与事务"]
SEED["lib/seed.ts<br/>初始化脚本"]
end
subgraph "数据层"
LAYERS["layers 表"]
CATEGORIES["categories 表"]
TECH_ITEMS["tech_items 表"]
end
API_L --> DB
API_C --> DB
API_T --> DB
API_S --> DB
SEED --> DB
DB --> LAYERS
DB --> CATEGORIES
DB --> TECH_ITEMS
```

图表来源
- [lib/db.ts](file://lib/db.ts#L14-L49)
- [lib/seed.ts](file://lib/seed.ts#L1-L14)
- [app/api/layers/route.ts](file://app/api/layers/route.ts#L1-L48)
- [app/api/categories/route.ts](file://app/api/categories/route.ts#L1-L48)
- [app/api/tech-items/route.ts](file://app/api/tech-items/route.ts#L1-L50)
- [app/api/stats/route.ts](file://app/api/stats/route.ts#L1-L15)

章节来源
- [lib/db.ts](file://lib/db.ts#L1-L312)
- [lib/seed.ts](file://lib/seed.ts#L1-L840)
- [types/index.ts](file://types/index.ts#L1-L34)
- [app/api/layers/route.ts](file://app/api/layers/route.ts#L1-L48)
- [app/api/categories/route.ts](file://app/api/categories/route.ts#L1-L48)
- [app/api/tech-items/route.ts](file://app/api/tech-items/route.ts#L1-L50)
- [app/api/stats/route.ts](file://app/api/stats/route.ts#L1-L15)
- [PROJECT_MIGRATION.md](file://PROJECT_MIGRATION.md#L122-L160)
- [package.json](file://package.json#L1-L43)

## 核心组件
- 数据库初始化与表结构
  - layers：层级表，包含 id、name、icon、display_order
  - categories：分类表，包含 id、name、icon、layer_id、display_order，并外键关联 layers.id
  - tech_items：技术项表，包含 id、name、category_id、status、priority、is_new、description、tags、display_order，并外键关联 categories.id
  - users：用户表（用于管理后台），包含 id、username（唯一）、password
- 数据访问接口
  - 层级：增删改查、批量排序
  - 分类：增删改查、批量排序
  - 技术项：增删改查、批量排序、按分类与显示顺序查询
  - 统计：活跃数、缺失数、总数与覆盖率
- 初始化脚本
  - 清空旧数据
  - 插入管理员用户
  - 创建层级、分类映射
  - 批量插入技术项，按分类映射写入

章节来源
- [lib/db.ts](file://lib/db.ts#L14-L49)
- [lib/db.ts](file://lib/db.ts#L52-L312)
- [lib/seed.ts](file://lib/seed.ts#L1-L14)
- [lib/seed.ts](file://lib/seed.ts#L18-L280)
- [lib/seed.ts](file://lib/seed.ts#L281-L840)
- [types/index.ts](file://types/index.ts#L1-L34)

## 架构总览
三层数据库架构的 ER 关系如下：

```mermaid
erDiagram
LAYERS {
integer id PK
text name
text icon
integer display_order
}
CATEGORIES {
integer id PK
text name
text icon
integer layer_id FK
integer display_order
}
TECH_ITEMS {
integer id PK
text name
integer category_id FK
text status
text priority
integer is_new
text description
text tags
integer display_order
}
USERS {
integer id PK
text username UK
text password
}
LAYERS ||--o{ CATEGORIES : "包含"
CATEGORIES ||--o{ TECH_ITEMS : "包含"
```

图表来源
- [lib/db.ts](file://lib/db.ts#L16-L42)
- [types/index.ts](file://types/index.ts#L1-L34)

说明
- 外键约束：categories.layer_id 引用 layers.id；tech_items.category_id 引用 categories.id
- 索引策略：当前未显式创建索引，但查询使用了 display_order 字段进行排序，建议后续根据查询模式增加索引
- 数据类型与约束：SQLite 使用通用类型，status/priority 使用 CHECK 约束限定枚举值

## 详细组件分析

### layers 层级表
- 字段与约束
  - id：主键，自增
  - name：非空，表示层级名称
  - icon：图标标识
  - display_order：默认 0，用于排序
- 业务含义
  - 代表技术栈的顶层分类，如“开发技术层”、“后端与大数据”等
- 查询与排序
  - 按 display_order 去重排序返回
- 外键关系
  - categories.layer_id 引用 layers.id

章节来源
- [lib/db.ts](file://lib/db.ts#L16-L22)
- [lib/db.ts](file://lib/db.ts#L52-L57)
- [types/index.ts](file://types/index.ts#L1-L6)

### categories 分类表
- 字段与约束
  - id：主键，自增
  - name：非空，分类名称
  - icon：图标标识
  - layer_id：非空，外键引用 layers.id
  - display_order：默认 0，用于排序
- 业务含义
  - 在某一层级下进一步细分，如“前端基础与框架”、“Java 生态”等
- 查询与排序
  - 按 layer_id 和 display_order 去重排序
- 外键关系
  - tech_items.category_id 引用 categories.id

章节来源
- [lib/db.ts](file://lib/db.ts#L24-L35)
- [lib/db.ts](file://lib/db.ts#L78-L85)
- [types/index.ts](file://types/index.ts#L8-L14)

### tech_items 技术项表
- 字段与约束
  - id：主键，自增
  - name：非空，技术项名称
  - category_id：非空，外键引用 categories.id
  - status：非空，CHECK 限定为 'active' 或 'missing'
  - priority：CHECK 限定为 'high' | 'medium' | 'low' | ''
  - is_new：默认 0，标记是否为新项
  - description：描述
  - tags：标签字符串
  - display_order：默认 0，用于排序
- 业务含义
  - 具体技术条目，如框架、语言、工具等
- 查询与排序
  - 按 category_id 和 display_order 去重排序
- 外键关系
  - 无额外外键，依赖约束保证 referential integrity

章节来源
- [lib/db.ts](file://lib/db.ts#L24-L35)
- [lib/db.ts](file://lib/db.ts#L107-L114)
- [types/index.ts](file://types/index.ts#L16-L26)

### users 用户表
- 字段与约束
  - id：主键，自增
  - username：非空且唯一
  - password：非空
- 业务含义
  - 用于管理后台的用户凭证（当前仅初始化，未在路由中启用鉴权）

章节来源
- [lib/db.ts](file://lib/db.ts#L44-L48)
- [lib/db.ts](file://lib/db.ts#L296-L309)
- [lib/seed.ts](file://lib/seed.ts#L15-L16)

### 数据访问模式与 API 路由
- 层级 API：GET/POST/PUT/DELETE，支持批量排序
- 分类 API：GET/POST/PUT/DELETE，支持批量排序
- 技术项 API：GET/POST/PUT/DELETE，支持批量排序
- 统计 API：GET，返回活跃、缺失、总数与覆盖率

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Route as "/api/tech-items"
participant DB as "lib/db.ts"
participant SQLite as "SQLite"
Client->>Route : "POST /api/tech-items"
Route->>DB : "addTechItem(data)"
DB->>SQLite : "INSERT INTO tech_items ..."
SQLite-->>DB : "lastInsertRowid"
DB-->>Route : "{id, ...}"
Route-->>Client : "JSON 响应"
```

图表来源
- [app/api/tech-items/route.ts](file://app/api/tech-items/route.ts#L16-L24)
- [lib/db.ts](file://lib/db.ts#L137-L162)

章节来源
- [app/api/layers/route.ts](file://app/api/layers/route.ts#L1-L48)
- [app/api/categories/route.ts](file://app/api/categories/route.ts#L1-L48)
- [app/api/tech-items/route.ts](file://app/api/tech-items/route.ts#L1-L50)
- [app/api/stats/route.ts](file://app/api/stats/route.ts#L1-L15)
- [lib/db.ts](file://lib/db.ts#L52-L312)

### 数据初始化脚本（seed）
- 流程
  - 初始化数据库表
  - 清空旧数据（避免重复）
  - 插入管理员用户
  - 定义层级并建立 name->id 映射
  - 定义分类并建立 name->id 映射
  - 定义技术项，按分类映射写入，设置 display_order
- 扩展方法
  - 新增层级：在层级数组中添加对象，seed 会自动插入并记录 lastInsertRowid
  - 新增分类：在分类数组中添加对象，指定 layer 名称，seed 会解析映射
  - 新增技术项：在技术项数组中添加对象，指定分类名称，seed 会解析映射
  - 批量导入：可读取外部 CSV/Excel 并调用对应 insert 方法

```mermaid
flowchart TD
Start(["开始"]) --> Init["initDb() 初始化表"]
Init --> Clear["clearDb() 清空旧数据"]
Clear --> AddUser["addUser('admin', '...')"]
AddUser --> Layers["遍历层级数组<br/>addLayer(name, icon, order)"]
Layers --> BuildLayerMap["记录 layerMap[name] -> id"]
BuildLayerMap --> Cats["遍历分类数组<br/>addCategory(name, icon, layer_id, order)"]
Cats --> BuildCatMap["记录 catMap[name] -> id"]
BuildCatMap --> Items["遍历技术项数组<br/>addTechItem({category_id, ...})"]
Items --> Done(["结束"])
```

图表来源
- [lib/seed.ts](file://lib/seed.ts#L10-L14)
- [lib/seed.ts](file://lib/seed.ts#L18-L31)
- [lib/seed.ts](file://lib/seed.ts#L33-L279)
- [lib/seed.ts](file://lib/seed.ts#L281-L840)

章节来源
- [lib/seed.ts](file://lib/seed.ts#L1-L840)
- [lib/db.ts](file://lib/db.ts#L14-L49)
- [lib/db.ts](file://lib/db.ts#L284-L294)

## 依赖分析
- 组件耦合
  - API 路由依赖 lib/db.ts 的数据访问函数
  - lib/db.ts 依赖 better-sqlite3 连接 SQLite
  - lib/seed.ts 依赖 lib/db.ts 的初始化与插入函数
- 外部依赖
  - better-sqlite3：SQLite 驱动
  - tsx：执行 seed 脚本
- 潜在循环依赖
  - 当前未发现循环依赖，各模块职责清晰

```mermaid
graph LR
Pkg["package.json<br/>scripts & deps"] --> Seed["lib/seed.ts"]
Seed --> DB["lib/db.ts"]
API_L["/api/layers/route.ts"] --> DB
API_C["/api/categories/route.ts"] --> DB
API_T["/api/tech-items/route.ts"] --> DB
API_S["/api/stats/route.ts"] --> DB
DB --> SQLite["SQLite 文件"]
```

图表来源
- [package.json](file://package.json#L5-L11)
- [lib/seed.ts](file://lib/seed.ts#L1-L8)
- [lib/db.ts](file://lib/db.ts#L1-L11)
- [app/api/layers/route.ts](file://app/api/layers/route.ts#L1-L2)
- [app/api/categories/route.ts](file://app/api/categories/route.ts#L1-L2)
- [app/api/tech-items/route.ts](file://app/api/tech-items/route.ts#L1-L2)
- [app/api/stats/route.ts](file://app/api/stats/route.ts#L1-L2)

章节来源
- [package.json](file://package.json#L1-L43)
- [lib/db.ts](file://lib/db.ts#L1-L11)
- [lib/seed.ts](file://lib/seed.ts#L1-L8)
- [app/api/layers/route.ts](file://app/api/layers/route.ts#L1-L2)
- [app/api/categories/route.ts](file://app/api/categories/route.ts#L1-L2)
- [app/api/tech-items/route.ts](file://app/api/tech-items/route.ts#L1-L2)
- [app/api/stats/route.ts](file://app/api/stats/route.ts#L1-L2)

## 性能考虑
- 索引策略
  - 建议为 categories.layer_id 建立索引，提升按层级查询效率
  - 建议为 tech_items.category_id 建立索引，提升按分类查询效率
  - 建议为 tech_items.status 建立索引，提升状态筛选效率
  - 建议为 layers.display_order、categories.display_order、tech_items.display_order 建立复合索引，优化排序
- 查询优化
  - 使用 ORDER BY 时尽量配合索引字段，减少排序成本
  - 使用 LIMIT/分页，避免一次性加载大量数据
- 写入优化
  - 批量更新使用事务（已实现），减少锁竞争
  - 批量插入使用 prepared statement，减少编译开销
- 存储与并发
  - SQLite 不支持高并发写入，建议在生产环境迁移到 PostgreSQL
  - 对于只读场景可考虑 WAL 模式提升并发读取能力

[本节为通用性能建议，不直接分析具体文件]

## 故障排查指南
- 数据库初始化失败
  - 确认 data/techmap.db 是否存在且可写
  - 检查 initDb() 是否正确执行
- API 返回错误
  - 查看 API 路由中的 try/catch 错误响应
  - 检查请求参数格式（如 id、name、icon、display_order 等）
- 数据不一致
  - 检查外键约束是否生效（category_id 必须存在）
  - 使用 SQLite CLI 验证数据一致性
- 重置数据库
  - 删除 data/techmap.db 后重新执行 npm run seed

章节来源
- [lib/db.ts](file://lib/db.ts#L14-L49)
- [app/api/layers/route.ts](file://app/api/layers/route.ts#L10-L12)
- [app/api/categories/route.ts](file://app/api/categories/route.ts#L10-L12)
- [app/api/tech-items/route.ts](file://app/api/tech-items/route.ts#L11-L13)
- [PROJECT_MIGRATION.md](file://PROJECT_MIGRATION.md#L116-L120)

## 结论
本数据库设计采用三层架构，层次清晰、外键约束明确，适合中小型项目与演示场景。通过 seed 脚本可快速完成初始化与扩展。建议在生产环境中引入索引、WAL 模式与 PostgreSQL，以提升性能与并发能力。

[本节为总结性内容，不直接分析具体文件]

## 附录

### 数据模型与字段说明
- layers
  - id：整型，主键，自增
  - name：文本，非空
  - icon：文本
  - display_order：整型，默认 0
- categories
  - id：整型，主键，自增
  - name：文本，非空
  - icon：文本
  - layer_id：整型，非空，外键引用 layers.id
  - display_order：整型，默认 0
- tech_items
  - id：整型，主键，自增
  - name：文本，非空
  - category_id：整型，非空，外键引用 categories.id
  - status：文本，非空，枚举 'active' | 'missing'
  - priority：文本，枚举 'high' | 'medium' | 'low' | ''
  - is_new：整型，默认 0
  - description：文本
  - tags：文本
  - display_order：整型，默认 0
- users
  - id：整型，主键，自增
  - username：文本，非空，唯一
  - password：文本，非空

章节来源
- [lib/db.ts](file://lib/db.ts#L16-L48)
- [types/index.ts](file://types/index.ts#L1-L34)

### SQL 查询示例（路径引用）
- 查询所有层级（按显示顺序）
  - [lib/db.ts](file://lib/db.ts#L53-L57)
- 查询所有分类（按层级与显示顺序）
  - [lib/db.ts](file://lib/db.ts#L78-L85)
- 查询所有技术项（按分类与显示顺序）
  - [lib/db.ts](file://lib/db.ts#L107-L114)
- 按状态统计
  - [lib/db.ts](file://lib/db.ts#L220-L239)

### 数据访问模式
- 层级 CRUD：getLayers、addLayer、updateLayer、deleteLayer
- 分类 CRUD：getCategories、addCategory、updateCategory、deleteCategory
- 技术项 CRUD：getTechItems、addTechItem、updateTechItem、deleteTechItem
- 批量排序：updateLayerOrder、updateCategoryOrder、updateTechItemOrder
- 统计：getStats

章节来源
- [lib/db.ts](file://lib/db.ts#L52-L312)

### 迁移与备份恢复
- 迁移策略
  - 通过 seed 脚本重建数据，确保一致性
  - 如需增量迁移，可在 seed 中加入版本号与迁移逻辑
- 备份恢复
  - 备份：复制 data/techmap.db
  - 恢复：替换 data/techmap.db 后重启服务
- 部署建议
  - 本地：直接部署 SQLite
  - 云端：建议替换为 PostgreSQL（参考项目迁移文档）

章节来源
- [PROJECT_MIGRATION.md](file://PROJECT_MIGRATION.md#L162-L195)